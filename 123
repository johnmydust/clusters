- name: Wait for pods to be in "Running" state
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ namespace }}"
    label_selectors:
      - app={{ test_deployment_name }}
  register: pod_info
  until: >
    pod_info.resources | map(attribute='status.phase') | select('equalto', 'Running') | length == {{ worker_node_list | length }}
  retries: 30
  delay: 10

- name: Get failing pods details
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ namespace }}"
    label_selectors:
      - app={{ test_deployment_name }}
  register: pod_details

- name: Display failing pods information
  debug:
    msg: >
      {{ pod_details.resources | selectattr('status.phase', 'ne', 'Running') |
      map(attribute='metadata.name') | join(', ') | default('All pods are running') }}

- name: Get pod distribution across nodes
  set_fact:
    pod_distribution: >
      {{ pod_details.resources | groupby('spec.nodeName') | dict() }}

- name: Display pod distribution
  debug:
    msg: "{{ pod_distribution }}"

- name: Verify pod distribution across workers
  set_fact:
    pods_per_node: "{{ pod_details.resources | map(attribute='spec.nodeName') | unique | length }}"

- name: Check if pods are distributed across all worker nodes
  fail:
    msg: >
      Pods are not distributed across all worker nodes.
      Expected: {{ worker_node_list | length }}. Found: {{ pods_per_node }}.
  when: pods_per_node != worker_node_list | length

- name: Delete test deployment and pods
  kubernetes.core.k8s:
    state: absent
    namespace: "{{ namespace }}"
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ test_deployment_name }}"

- name: Remove local images
  block:
    - name: Remove test image
      command:
        cmd: podman rmi default-route-openshift-image-registry.apps.{{ cluster_domain.stdout }}/{{ namespace }}/{{ registry_image }}
      ignore_errors: true

    - name: Remove busybox image
      command:
        cmd: podman rmi {{ registry_image }}
      ignore_errors: true

